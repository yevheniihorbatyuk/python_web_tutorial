# Урок 2: Архітектура черги завдань Celery + Redis

**Мета**: Зрозуміти, як асинхронно обробляти тривалі завдання.

---

## Проблема: блокуючі операції

У веб-додатках деякі операції займають багато часу (наприклад, надсилання електронних листів, веб-скрапінг, обробка зображень). Якщо вони виконуються під час веб-запиту користувача, користувач змушений чекати, що призводить до поганого досвіду.

**Рішення**: виконувати ці тривалі завдання у фоновому режимі. Веб-додаток може негайно повернути відповідь користувачеві, тоді як окремий процес виконує важку роботу.

---

## Celery: фреймворк черги завдань

Celery — це розподілена черга завдань, яка спеціалізується на обробці асинхронних завдань.

### Основні компоненти

1.  **Веб-додаток (продюсер)**: надсилає завдання ("таск") до черги.
2.  **Брокер (черга повідомлень)**: посередник (наприклад, **Redis**), який зберігає чергу завдань, що очікують на обробку.
3.  **Celery Worker (споживач)**: окремий фоновий процес, який постійно забирає завдання з брокера та виконує їх.
4.  **Бекенд результатів**: місце (часто також **Redis**), де воркер зберігає результати завдань.

```
Django App ───► Redis Broker ───► Celery Worker
    ▲                 │                  │
    └─────────────────┴── Redis Backend ◄┘
```

---

## Ключові концепції

- **Task**: функція Python, зазвичай декорована `@shared_task`, яка представляє одиницю роботи.
- **Брокер**: зберігає завдання. Redis є популярним вибором, оскільки він швидкий і працює в пам'яті.
- **Воркер**: виконує завдання. Ви можете запускати кілька воркерів для паралельної обробки завдань.
- **Бекенд**: зберігає стан і результат завдання, дозволяючи вашому веб-додатку перевіряти його прогрес.

### Життєвий цикл завдання

1.  **Надсилання**: ваше представлення Django викликає `my_task.delay(arg1)`. Завдання надсилається до брокера.
2.  **Черга**: брокер утримує завдання, доки воркер не звільниться.
3.  **Виконання**: воркер забирає завдання та виконує функцію Python.
4.  **Збереження результату**: після завершення воркер зберігає повернуте значення або будь-яку помилку в бекенді результатів.

### Стани завдань

Завдання проходить через кілька станів:
- `PENDING`: очікування в черзі.
- `STARTED`: воркер почав його виконання.
- `SUCCESS`: успішно завершено.
- `FAILURE`: сталася помилка.
- `RETRY`: завдання не вдалося, і буде повторна спроба.

---
## Додаткові ресурси

- **Документація Celery**: https://docs.celeryproject.io/
- **Flower (інструмент моніторингу Celery)**: https://flower.readthedocs.io/
- **Вступ до Redis**: https://redis.io/docs/about/
