# Туторіал: Початок роботи з чергами завдань Celery

**Мета**: Створити та запустити ваші перші асинхронні завдання з Celery та Redis.

---

## Передумови

- Встановлені Celery та Redis (`pip install celery redis`).
- Запущений сервер Redis. Ви можете легко запустити його за допомогою Docker: `docker run -d -p 6379:6379 redis`.

---

## Крок 1: Визначення додатку Celery та завдання

1.  **Створіть файл `tasks.py`**. Тут ви визначите ваш додаток Celery та ваші завдання.

    ```python
    from celery import Celery
    import time

    # 1. Створіть екземпляр Celery
    # Перший аргумент — це назва поточного модуля.
    # Аргумент `broker` вказує URL брокера повідомлень (Redis).
    # Аргумент `backend` вказує URL бекенда результатів.
    app = Celery('tasks', broker='redis://localhost:6379/0', backend='redis://localhost:6379/0')

    # 2. Визначте завдання
    @app.task
    def long_running_task(seconds):
        """Просте завдання, яке імітує тривалу операцію, засинаючи."""
        print(f"Завдання розпочато: спимо {seconds} секунд.")
        time.sleep(seconds)
        print("Завдання завершено.")
        return f"Проспали {seconds} секунд."
    ```

---

## Крок 2: Запуск воркера Celery

Відкрийте новий термінал, перейдіть до каталогу, що містить `tasks.py`, і запустіть воркер.

```bash
celery -A tasks worker --loglevel=info
```
- `-A tasks`: вказує екземпляр додатка для використання (об'єкт `app` у `tasks.py`).
- `worker`: команда для запуску процесу воркера.
- `--loglevel=info`: встановлює рівень логування.

Ви повинні побачити, як воркер запускається і повідомляє, що він готовий приймати завдання.

---

## Крок 3: Надсилання завдання

Тепер дамо воркеру роботу.

1.  **Відкрийте інший термінал** і запустіть оболонку Python.
    ```bash
    python
    ```
2.  **Імпортуйте ваше завдання та запустіть його асинхронно**, використовуючи метод `.delay()`.

    ```python
    from tasks import long_running_task

    # Це надсилає завдання до брокера повідомлень.
    # Воно негайно повертає об'єкт AsyncResult.
    result = long_running_task.delay(5)

    print(f"Завдання надіслано з ID: {result.id}")
    ```
    - `.delay()` — це скорочення для `.apply_async()`. Воно надсилає завдання до черги та негайно повертає вам керування.

---

## Крок 4: Перевірка статусу та результату завдання

У тій же оболонці Python ви можете перевірити стан вашого завдання.

```python
# Перевірити, чи завдання завершено
>>> result.ready()
False

# Перевірити статус
>>> result.status
'PENDING' # Або 'STARTED', якщо воркер його вже взяв

# Дочекатися завершення завдання та отримати результат
# Це буде блокувати, доки результат не буде доступний.
>>> final_result = result.get(timeout=10)
>>> print(final_result)
'Проспали 5 секунд.'

# Тепер завдання готове
>>> result.ready()
True

>>> result.status
'SUCCESS'
```

Поки ви чекаєте на результат, ви можете спостерігати за логами в терміналі вашого воркера Celery, щоб побачити, як він приймає та виконує завдання.
