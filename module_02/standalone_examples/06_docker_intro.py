"""
Модуль 02.6: Docker Introduction
==================================

Генерує Dockerfile для chatbot-demo з поясненнями.
Запустіть і перенаправте вивід:

  python 06_docker_intro.py > Dockerfile

Потім:
  docker build -t chatbot .
  docker run -it chatbot          # -i = interactive stdin, -t = pseudo-TTY

Що вивчається:
  - image vs container (клас vs екземпляр)
  - Dockerfile інструкції: FROM, WORKDIR, COPY, RUN, CMD
  - Прапорці -i та -t: коли і для чого
  - Різниця між -it (інтерактивний) та -d (фоновий) режимами
"""

import sys


# ─── Dockerfile контент ───────────────────────────────────────────────────────

DOCKERFILE = """\
# ──────────────────────────────────────────────────────────────────────────────
# FROM — базовий образ.
# python:3.11-slim: офіційний образ Python, "slim" без зайвих системних пакетів
# (~130 MB vs ~900 MB для повного образу)
# ──────────────────────────────────────────────────────────────────────────────
FROM python:3.11-slim

# ──────────────────────────────────────────────────────────────────────────────
# WORKDIR — робоча директорія всередині контейнера.
# Всі наступні команди виконуються відносно /app.
# Директорія буде створена автоматично.
# ──────────────────────────────────────────────────────────────────────────────
WORKDIR /app

# ──────────────────────────────────────────────────────────────────────────────
# COPY — копіює файли з хост-машини в образ.
# requirements.txt копіюємо окремо: Docker кешує шари.
# Якщо requirements.txt не змінився — pip install не буде перезапущений.
# ──────────────────────────────────────────────────────────────────────────────
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Копіюємо вихідний код ПІСЛЯ встановлення залежностей (кеш-ефективність)
COPY 05_chatbot_demo.py .

# ──────────────────────────────────────────────────────────────────────────────
# CMD — команда за замовчуванням при запуску контейнера.
# Exec form ["python", "..."] — кращий за shell form "python ..."
# Exec form: сигнали (SIGTERM) йдуть безпосередньо до python, не до bash
# ──────────────────────────────────────────────────────────────────────────────
CMD ["python", "05_chatbot_demo.py"]
"""

# ─── Пояснення команд Docker ─────────────────────────────────────────────────

DOCKER_GUIDE = """
╔══════════════════════════════════════════════════════════════════════════════╗
║                    Docker: Image vs Container                               ║
╚══════════════════════════════════════════════════════════════════════════════╝

  Image   ≈ Клас Python
  Container ≈ Екземпляр класу (instance)

  Один image → скільки завгодно container'ів
  Container не змінює image (якщо не зробити docker commit)

━━━ Основні команди ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  docker build -t chatbot .         # зібрати image з Dockerfile в поточній директорії
  docker images                     # список всіх images
  docker ps                         # запущені контейнери
  docker ps -a                      # всі контейнери (включно зі зупиненими)

━━━ Запуск контейнера ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  docker run -it chatbot

    -i  (--interactive)  Тримати stdin відкритим — для введення з клавіатури
    -t  (--tty)          Псевдо-термінал — для коректного відображення виводу

    Обидва потрібні для ІНТЕРАКТИВНИХ програм (наш чат-бот, bash, python REPL)

  docker run -d chatbot             # detached (фон) — для серверів (FastAPI, PostgreSQL)
                                    # stdin не потрібен, сервер слухає порт
  docker run -p 8000:8000 chatbot   # пробросити порт хоста в контейнер

━━━ Управління контейнерами ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  docker stop <id>                  # зупинити контейнер (SIGTERM → SIGKILL після 10с)
  docker rm <id>                    # видалити зупинений контейнер
  docker rmi chatbot                # видалити image
  docker logs <id>                  # подивитись stdout/stderr контейнера
  docker exec -it <id> bash         # відкрити shell в запущеному контейнері

━━━ .dockerignore ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  Файл .dockerignore виключає файли з docker build context (як .gitignore):

    .venv/
    __pycache__/
    .env           ← НІКОЛИ не включати секрети в image!
    *.pyc

━━━ Чому -it для бота, але не для FastAPI? ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  Чат-бот читає input() → потребує stdin → -i
  Чат-бот виводить у термінал → красивіше з -t

  FastAPI сервер → не читає stdin → -d (фон) + -p 8000:8000 (порт)

"""

# ─── Головна логіка ──────────────────────────────────────────────────────────

def main() -> None:
    # Якщо stdout перенаправлений у файл — виводимо тільки Dockerfile
    if not sys.stdout.isatty():
        print(DOCKERFILE, end="")
        return

    # Інтерактивний режим — виводимо і Dockerfile і пояснення
    print("=" * 70)
    print("  Dockerfile для chatbot-demo")
    print("=" * 70)
    print(DOCKERFILE)
    print(DOCKER_GUIDE)
    print("─" * 70)
    print("Щоб зберегти Dockerfile: python 06_docker_intro.py > Dockerfile")


if __name__ == "__main__":
    main()
